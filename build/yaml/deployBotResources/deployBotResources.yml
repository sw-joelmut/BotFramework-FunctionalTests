#
# Deploys the bot resources needed for the Skills Functional Tests.
#

name: "$(Build.BuildId)"
trigger: none
pr: none

pool:
  vmImage: "windows-2019"

variables:
  BuildConfiguration: "Debug"
  BuildPlatform: "AnyCPU"
  ## Azure Resources (Define these variables in Azure)
  # AzureSubscription: Service Connection Name to Manage Azure resources.
  # AppServicePlanGroup: (optional) Name of the Resource Group where the Windows App Service Plan is located.
  # AppServicePlanGroupLinux: (optional) Name of the Resource Group where the Linux App Service Plan is located.
  # AppServicePlanDotNetName: (optional) Name of the DotNet App Service Plan.
  # AppServicePlanJSName: (optional) Name of the JavaScript App Service Plan.
  # AppServicePlanPythonName: (optional) Name of the Python App Service Plan.
  # BotPricingTier: (optional) Pricing Tier for the bots, default F0.
  # ResourceGroup: (optional) Name of the Resource Group where the bots will be deployed.
  # ResourceSuffix: (optional) Suffix to add to the resources' name to avoid collitions.

  ## Bots Configuration (Define these variables in Azure)
  # BffnEchoSkillBotComposerDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotComposerDotNetAppSecret: (optional) App Secret for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNet21AppId: (optional) App Id for BffnEchoSkillBotDotNet21 bot.
  # BffnEchoSkillBotDotNet21AppSecret: (optional) App Secret for BffnEchoSkillBotDotNet21 bot.
  # BffnEchoSkillBotDotNetAppId: (optional) App Id for BffnEchoSkillBotDotNet bot.
  # BffnEchoSkillBotDotNetAppSecret: (optional) App Secret for BffnEchoSkillBotDotNet bot.
  # BffnEchoSkillBotDotNetV3AppId: (optional) App Id for BffnEchoSkillBotDotNetV3 bot.
  # BffnEchoSkillBotDotNetV3AppSecret: (optional) App Secret for BffnEchoSkillBotDotNetV3 bot.
  # BffnEchoSkillBotJSAppId: (optional) App Id for BffnEchoSkillBotJS bot.
  # BffnEchoSkillBotJSAppSecret: (optional) App Secret for BffnEchoSkillBotJS bot.
  # BffnEchoSkillBotJSV3AppId: (optional) App Id for BffnEchoSkillBotJSV3 bot.
  # BffnEchoSkillBotJSV3AppSecret: (optional) App Secret for BffnEchoSkillBotJSV3 bot.
  # BffnEchoSkillBotPythonAppId: (optional) App Id for BffnEchoSkillBotPython bot.
  # BffnEchoSkillBotPythonAppSecret: (optional) App Secret for BffnEchoSkillBotPython bot.
  # BffnSimpleHostBotComposerDotNetAppId: (optional) App Id for BffnSimpleHostBotComposerDotNet bot.
  # BffnSimpleHostBotComposerDotNetAppSecret: (optional) App Secret for BffnSimpleHostBotComposerDotNet bot.
  # BffnSimpleHostBotDotNet21AppId: (optional) App Id for BffnSimpleHostBotDotNet21 bot.
  # BffnSimpleHostBotDotNet21AppSecret: (optional) App Secret for BffnSimpleHostBotDotNet21 bot.
  # BffnSimpleHostBotDotNetAppId: (optional) App Id for BffnSimpleHostBotDotNet bot.
  # BffnSimpleHostBotDotNetAppSecret: (optional) App Secret for BffnSimpleHostBotDotNet bot.
  # BffnSimpleHostBotJSAppId: (optional) App Id for BffnSimpleHostBotJS bot.
  # BffnSimpleHostBotJSAppSecret: (optional) App Secret for BffnSimpleHostBotJS bot.
  # BffnSimpleHostBotPythonAppId: (optional) App Id for BffnSimpleHostBotPython bot.
  # BffnSimpleHostBotPythonAppSecret: (optional) App Secret for BffnSimpleHostBotPython bot.
  # BffnWaterfallHostBotDotNetAppId: (optional) App Id for BffnWaterfallHostBotDotNet bot.
  # BffnWaterfallHostBotDotNetAppSecret: (optional) App Secret for BffnWaterfallHostBotDotNet bot.
  # BffnWaterfallSkillBotDotNetAppId: (optional) App Id for BffnWaterfallSkillBotDotNet bot.
  # BffnWaterfallSkillBotDotNetAppSecret: (optional) App Secret for BffnWaterfallSkillBotDotNet bot.
  # BffnWaterfallHostBotJSAppId: (optional) App Id for BffnWaterfallHostBotJS bot.
  # BffnWaterfallHostBotJSAppSecret: (optional) App Secret for BffnWaterfallHostBotJS bot.
  # BffnWaterfallSkillBotJSAppId: (optional) App Id for BffnWaterfallSkillBotJS bot.
  # BffnWaterfallSkillBotJSAppSecret: (optional) App Secret for BffnWaterfallSkillBotJS bot.
  # BffnWaterfallHostBotPythonAppId: (optional) App Id for BffnWaterfallHostBotPython bot.
  # BffnWaterfallHostBotPythonAppSecret: (optional) App Secret for BffnWaterfallHostBotPython bot.
  # BffnWaterfallSkillBotPythonAppId: (optional) App Id for BffnWaterfallSkillBotPython bot.
  # BffnWaterfallSkillBotPythonAppSecret: (optional) App Secret for BffnWaterfallSkillBotPython bot.
  # ConnectionName: (optional) Name for the OAuth connection to use in the skill bots.

  ## Package Dependencies (define in Azure)
  # DependenciesRegistryDotNetHosts: (optional) Registry to download the dependency packages for the DotNet host bots.
  # DependenciesRegistryDotNetSkills: (optional) Registry to download the dependency packages for the DotNet skill bots.
  # DependenciesRegistryDotNetSkillsV3: (optional) Registry to download the dependency packages for the DotNet v3 skill bots.
  # DependenciesVersionDotNetHosts: (optional) Version of the dependency packages for the DotNet host bots.
  # DependenciesVersionDotNetSkills: (optional) Version of the dependency packages for the DotNet skill bots.
  # DependenciesVersionDotNetSkillsV3: (optional) Version of the dependency packages for the DotNet v3 skill bots.
  # DependenciesRegistryJSHosts: (optional) Registry to download the dependency packages for the JS host bots.
  # DependenciesRegistryJSSkills: (optional) Registry to download the dependency packages for the JS skill bots.
  # DependenciesRegistryJSSkillsV3: (optional) Registry to download the dependency packages for the JS v3 skill bots.
  # DependenciesVersionJSHosts: (optional) Version of the dependency packages for the JS host bots.
  # DependenciesVersionJSSkills: (optional) Version of the dependency packages for the JS skill bots.
  # DependenciesVersionJSSkillsV3: (optional) Version of the dependency packages for the JS skill v3 bots.
  # DependenciesRegistryPythonHosts: (optional) Registry to download the dependency packages for the Python host bots.
  # DependenciesRegistryPythonSkills: (optional) Registry to download the dependency packages for the Python skill bots.
  # DependenciesVersionPythonHosts: (optional) Version of the dependency packages for the Python host bots.
  # DependenciesVersionPythonSkills: (optional) Version of the dependency packages for the Python skill bots.

  ## Internal variables
  InternalAppInsightsName: 'bffnappinsights$(InternalResourceSuffix)'
  InternalAppServicePlanWindowsResourceGroup: $[coalesce(variables['AppServicePlanGroup'], 'bffnshared')]
  InternalAppServicePlanLinuxResourceGroup: $[coalesce(variables['AppServicePlanGroupLinux'], 'bffnshared-linux')]
  InternalAppServicePlanDotNetName: $[coalesce(variables['AppServicePlanDotNetName'], 'bffnbotsappservicedotnet$(InternalResourceSuffix)')]
  InternalAppServicePlanJSName: $[coalesce(variables['AppServicePlanJSName'], 'bffnbotsappservicejs$(InternalResourceSuffix)')]
  InternalAppServicePlanPythonName: $[coalesce(variables['AppServicePlanPythonName'], 'bffnbotsappservicepython$(InternalResourceSuffix)')]
  InternalKeyVaultName: 'bffnbotkeyvault$(InternalResourceSuffix)'
  InternalResourceGroupName: $[coalesce(variables['ResourceGroup'], 'bffnbots')]
  InternalResourceSuffix: $[coalesce(variables['ResourceSuffix'], '')]


stages:
# Resource Groups
  - template: common/prepareResources.yml
    parameters:
      azureSubscription: "$(AzureSubscription)"
      resourceGroups: 
        - id: "Prepare_DotNetGroup"
          name: "$(InternalResourceGroupName)-DotNet"
          displayName: "Prepare DotNet's Resource Group"

        - id: "Prepare_JSGroup"
          name: "$(InternalResourceGroupName)-JS"
          displayName: "Prepare JS's Resource Group"

        - id: "Prepare_PythonGroup"
          name: "$(InternalResourceGroupName)-Python"
          displayName: "Prepare Python's Resource Group"

# DotNet
  - template: dotnet/deploy.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanDotNetName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      connectionName: $env:ConnectionName
      dependsOn: "Prepare_DotNetGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotdotnet"
          type: "Host"
          displayName: "DotNet Simple Host Bot"
          appId: $(BffnSimpleHostBotDotNetAppId)
          appSecret: $(BffnSimpleHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot'
            name: "SimpleHostBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnsimplehostbotdotnet21"
          type: "Host"
          displayName: "DotNet Simple Host Bot 2.1"
          appId: $(BffnSimpleHostBotDotNet21AppId)
          appSecret: $(BffnSimpleHostBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot-2.1'
            name: "SimpleHostBot-2.1.csproj"
            netCoreVersion: "2.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnechoskillbotdotnet"
          type: "Skill"
          displayName: "DotNet Echo Skill Bot"
          appId: $(BffnEchoSkillBotDotNetAppId)
          appSecret: $(BffnEchoSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot'
            name: "EchoSkillBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

        - name: "bffnechoskillbotdotnet21"
          type: "Skill"
          displayName: "DotNet Echo Skill Bot 2.1"
          appId: $(BffnEchoSkillBotDotNet21AppId)
          appSecret: $(BffnEchoSkillBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-2.1'
            name: "EchoSkillBot-2.1.csproj"
            netCoreVersion: "2.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

        - name: "bffnechoskillbotdotnetv3"
          type: "SkillV3"
          displayName: "DotNet Echo Skill Bot v3"
          appId: $(BffnEchoSkillBotDotNetV3AppId)
          appSecret: $(BffnEchoSkillBotDotNetV3AppSecret)
          project:
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-v3'
            name: "EchoSkillBot-v3.csproj"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkillsV3
            version: $env:DependenciesVersionDotNetSkillsV3

        - name: "bffnwaterfallhostbotdotnet"
          type: "Host"
          displayName: "DotNet Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotDotNetAppId)
          appSecret: $(BffnWaterfallHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/WaterfallHostBot'
            name: "WaterfallHostBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnwaterfallskillbotdotnet"
          type: "Skill"
          displayName: "DotNet Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotDotNetAppId)
          appSecret: $(BffnWaterfallSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/WaterfallSkillBot'
            name: "WaterfallSkillBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

# DotNet Composer
  - template: dotnet/deployComposer.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanDotNetName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      dependsOn: "Prepare_DotNetGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotcomposerdotnet"
          type: "Host"
          displayName: "DotNet Simple Composer Host Bot"
          appId: $(BffnSimpleHostBotComposerDotNetAppId)
          appSecret: $(BffnSimpleHostBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/Composer/SimpleHostBotComposer'
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnechoskillbotcomposerdotnet"
          type: "Skill"
          displayName: "DotNet Echo Composer Skill Bot"
          appId: $(BffnEchoSkillBotComposerDotNetAppId)
          appSecret: $(BffnEchoSkillBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/Composer/EchoSkillBotComposer'
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

# JS
  - template: js/deploy.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanJSName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      connectionName: $env:ConnectionName
      dependsOn: "Prepare_JSGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-JS"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotjs"
          type: "Host"
          displayName: "JS Simple Host Bot"
          appId: $(BffnSimpleHostBotJSAppId)
          appSecret: $(BffnSimpleHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/SimpleHostBot'
          dependency:
            registry: $env:DependenciesRegistryJSHosts
            version: $env:DependenciesVersionJSSHosts

        - name: "bffnechoskillbotjs"
          type: "Skill"
          displayName: "JS Echo Skill Bot"
          appId: $(BffnEchoSkillBotJSAppId)
          appSecret: $(BffnEchoSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot'
          dependency:
            registry: $env:DependenciesRegistryJSSkills
            version: $env:DependenciesVersionJSSkills

        - name: "bffnechoskillbotjsv3"
          type: "SkillV3"
          displayName: "JS Echo Skill Bot v3"
          appId: $(BffnEchoSkillBotJSV3AppId)
          appSecret: $(BffnEchoSkillBotJSV3AppSecret)
          project:
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot-v3'
          dependency:
            registry: $env:DependenciesRegistryJSSkillsV3
            version: $env:DependenciesVersionJSSkillsV3

        - name: "bffnwaterfallhostbotjs"
          type: "Host"
          displayName: "JS Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotJSAppId)
          appSecret: $(BffnWaterfallHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/WaterfallHostBot'
          dependency:
            registry: $env:DependenciesRegistryJSHosts
            version: $env:DependenciesVersionJSSHosts

        - name: "bffnwaterfallskillbotjs"
          type: "Skill"
          displayName: "JS Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotJSAppId)
          appSecret: $(BffnWaterfallSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/WaterfallSkillBot'
          dependency:
            registry: $env:DependenciesRegistryJSSkills
            version: $env:DependenciesVersionJSSkills

# Python
  - template: python/deploy.yml
    parameters:
      appServicePlan: "$(InternalAppServicePlanPythonName)"
      appServicePlanRG: "$(InternalAppServicePlanLinuxResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BOTPRICINGTIER
      connectionName: $env:CONNECTIONNAME
      dependsOn: "Prepare_PythonGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-Python"
      resourceSuffix: "$(InternalResourceSuffix)"
      bots:
        - name: "bffnsimplehostbotpython"
          type: "Host"
          displayName: "Python Simple Host Bot"
          appId: $(BffnSimpleHostBotPythonAppId)
          appSecret: $(BffnSimpleHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/SimpleHostBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONHOSTS
            version: $env:DEPENDENCIESVERSIONPYTHONHOSTS

        - name: "bffnechoskillbotpython"
          type: "Skill"
          displayName: "Python Echo Skill Bot"
          appId: $(BffnEchoSkillBotPythonAppId)
          appSecret: $(BffnEchoSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/EchoSkillBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONSKILLS
            version: $env:DEPENDENCIESVERSIONPYTHONSKILLS

        - name: "bffnwaterfallhostbotpython"
          type: "Host"
          displayName: "Python Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotPythonAppId)
          appSecret: $(BffnWaterfallHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/WaterfallHostBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONHOSTS
            version: $env:DEPENDENCIESVERSIONPYTHONHOSTS

        - name: "bffnwaterfallskillbotpython"
          type: "Skill"
          displayName: "Python Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotPythonAppId)
          appSecret: $(BffnWaterfallSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/WaterfallSkillBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONSKILLS
            version: $env:DEPENDENCIESVERSIONPYTHONSKILLS

# Publish variables
  - stage: "Publish_Variables"
    displayName: "Publish Variables"
    dependsOn: []
    jobs:
      - job: "Publish_Variables"
        displayName: "Publish Variables"
        steps:
          - powershell: |
              $variables = @{
                deploymentBuildSuffix = "$(Build.BuildId)"
              }
              Write-Host $variables
              New-Item -Path "$(System.DefaultWorkingDirectory)" -Name "variables" -ItemType "directory"
              $variables | ConvertTo-Json | Out-File "$(System.DefaultWorkingDirectory)/Variables/variables.json"
            displayName: "Create Variables file"

          - task: PublishPipelineArtifact@1
            displayName: "Publish Variables as artifact"
            inputs:
              targetPath: "$(System.DefaultWorkingDirectory)/variables"
              artifactName: Variables
